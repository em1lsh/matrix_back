# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –º–æ–¥–µ–ª–µ–π

**–î–∞—Ç–∞:** 2024-12-03  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

## –ü—Ä–æ–±–ª–µ–º–∞

–ü–µ—Ä–µ–¥ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–º –º–æ–¥–µ–ª–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –±—ã–ª–æ —Å–æ–∑–¥–∞—Ç—å baseline —Ç–µ—Å—Ç—ã, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –û–¥–Ω–∞–∫–æ —Ç–µ—Å—Ç—ã –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∏ –∏–∑-–∑–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º:

1. ‚ùå DATABASE –Ω–µ —á–∏—Ç–∞–ª—Å—è –∏–∑ .env.test
2. ‚ùå –¢–µ—Å—Ç—ã –ø—ã—Ç–∞–ª–∏—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQLite –≤–º–µ—Å—Ç–æ PostgreSQL
3. ‚ùå Event loop –∑–∞–∫—Ä—ã–≤–∞–ª—Å—è –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
4. ‚ùå –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –æ—á–∏—â–∞–ª–∏—Å—å –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏

## –†–µ—à–µ–Ω–∏–µ

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è DATABASE

**–§–∞–π–ª:** `backend/project/app/configs/__init__.py`

**–ü—Ä–æ–±–ª–µ–º–∞:** Pydantic –∏—Å–∫–∞–ª –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `database` –≤–º–µ—Å—Ç–æ `DATABASE`

**–†–µ—à–µ–Ω–∏–µ:**
```python
database: str = Field(
    default="sqlite+aiosqlite:///test.db", 
    validation_alias="DATABASE"
)
```

### 2. –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è–º–∏

**–§–∞–π–ª—ã:**
- `backend/project/app/configs/__init__.py`
- `backend/project/alembic/env.py`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- `ENV=test` ‚Üí –∑–∞–≥—Ä—É–∂–∞–µ—Ç `.env.test`
- `ENV=dev` ‚Üí –∑–∞–≥—Ä—É–∂–∞–µ—Ç `.env.dev`
- `ENV=prod` ‚Üí –∑–∞–≥—Ä—É–∂–∞–µ—Ç `.env` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å event loop

**–§–∞–π–ª:** `backend/project/app/db/database.py`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ commit SQLAlchemy –¥–µ–ª–∞–ª expire –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤, —á—Ç–æ —Ç—Ä–µ–±–æ–≤–∞–ª–æ –Ω–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î, –Ω–æ event loop —É–∂–µ –±—ã–ª –∑–∞–∫—Ä—ã—Ç

**–†–µ—à–µ–Ω–∏–µ:**
```python
SessionLocal = async_sessionmaker(
    autocommit=False,
    autoflush=False,
    bind=engine,
    class_=AsyncSession,
    expire_on_commit=False,  # –ù–µ –¥–µ–ª–∞—Ç—å expire –ø–æ—Å–ª–µ commit
)
```

### 4. –°–æ–∑–¥–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –æ—á–∏—Å—Ç–∫–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª:** `backend/tests/conftest.py`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–∫—Å—Ç—É—Ä–∞ `clean_db` —Å `autouse=True`
- –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º
- –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö 32 —Ç–∞–±–ª–∏—Ü –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å–µ—Å—Å–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü—ã (–∏–∑–±–µ–≥–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏)

### 5. –°–æ–∑–¥–∞–Ω—ã baseline —Ç–µ—Å—Ç—ã

**–§–∞–π–ª:** `backend/tests/test_models_baseline.py`

**–¢–µ—Å—Ç—ã:**
1. `test_user_model_basic_operations` - CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å User
2. `test_nft_model_with_relationships` - NFT —Å relationships
3. `test_balance_operations` - –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–ª–∞–Ω—Å–æ–º
4. `test_account_password_methods` - –ú–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å –ø–∞—Ä–æ–ª–µ–º
5. `test_auction_with_bids` - –ê—É–∫—Ü–∏–æ–Ω —Å–æ —Å—Ç–∞–≤–∫–∞–º–∏
6. `test_nft_offer_model` - –ú–æ–¥–µ–ª—å NFTOffer
7. `test_table_names` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω —Ç–∞–±–ª–∏—Ü
8. `test_model_columns_exist` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫
9. `test_model_imports` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤ –º–æ–¥–µ–ª–µ–π

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

```bash
$ $env:ENV="test"; cd backend/project; poetry run pytest ../tests/test_models_baseline.py -v

========================================= 9 passed in 1.19s ===========================================
```

‚úÖ –í—Å–µ 9 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ  
‚úÖ PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ —Ç–µ—Å—Ç–æ–≤–∞—è –ë–î  
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç  
‚úÖ Event loop —Å—Ç–∞–±–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏

## –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

### –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```bash
$env:ENV="test"
cd backend/project
poetry run python ../tests/clean_test_data.py
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü
```bash
$env:ENV="test"
cd backend/project
poetry run python ../tests/check_tables.py
```

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
```bash
$env:ENV="test"
cd backend/project
poetry run alembic upgrade head
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø—Ä–æ–≤–æ–¥–∏—Ç—å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –º–æ–¥–µ–ª–µ–π:

1. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å baseline —Ç–µ—Å—Ç—ã (–¥–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏)
2. üîÑ –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –º–æ–¥–µ–ª–∏
3. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Å–Ω–æ–≤–∞ (–¥–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏)
4. ‚ùå –ï—Å–ª–∏ —Ç–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç ‚Üí –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–ª–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** `backend/docs/TESTING_SETUP.md`
- **–ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:** `backend/docs/MODELS_REFACTORING_PLAN.md`

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î

**–§–∞–π–ª:** `backend/.env.test`

```env
DATABASE=postgresql+asyncpg://postgres:postgres@localhost:5432/loadtest_db
```

### Event loop scope

**–§–∞–π–ª:** `backend/tests/conftest.py`

```python
@pytest.fixture(scope="module")
def event_loop():
    """–°–æ–∑–¥–∞—Ç—å –æ–¥–∏–Ω event loop –¥–ª—è –º–æ–¥—É–ª—è —Ç–µ—Å—Ç–æ–≤."""
    loop = asyncio.new_event_loop()
    yield loop
    loop.close()
```

### –ü–æ—Ä—è–¥–æ–∫ –æ—á–∏—Å—Ç–∫–∏ —Ç–∞–±–ª–∏—Ü

–í–∞–∂–Ω–æ —Å–æ–±–ª—é–¥–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è (—Å–Ω–∞—á–∞–ª–∞ –¥–æ—á–µ—Ä–Ω–∏–µ, –ø–æ—Ç–æ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ):

1. Tonnel tables (tonnel_offers, tonnel_nfts, ...)
2. Trade tables (trade_deals, trade_applications, ...)
3. NFT and auction tables (nft_orders, auction_bids, ...)
4. Market tables (market_nft_floors, markets)
5. Channel tables (channels_gifts, channels)
6. Balance tables (balance_withdraws, balance_topups)
7. Account and user tables (accounts, gifts, users)

## –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: "unknown function: now()"
**–ü—Ä–∏—á–∏–Ω–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SQLite –≤–º–µ—Å—Ç–æ PostgreSQL  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `ENV=test` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ DATABASE –ø—Ä–∞–≤–∏–ª—å–Ω–æ —á–∏—Ç–∞–µ—Ç—Å—è

### –ü—Ä–æ–±–ª–µ–º–∞: "Event loop is closed"
**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–æ–±–ª–µ–º—ã —Å event loop –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏  
**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `expire_on_commit=False` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ SessionLocal

### –ü—Ä–æ–±–ª–µ–º–∞: "UniqueViolationError"
**–ü—Ä–∏—á–∏–Ω–∞:** –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –æ—á–∏—â–∞—é—Ç—Å—è –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏  
**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–ø—É—Å—Ç–∏—Ç—å `clean_test_data.py` –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∏–∫—Å—Ç—É—Ä—É `clean_db`

### –ü—Ä–æ–±–ª–µ–º–∞: "InFailedSQLTransactionError"
**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã –≤ –ø—Ä–µ—Ä–≤–∞–Ω–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏  
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é —Å–µ—Å—Å–∏—é –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–¢–µ—Å—Ç–æ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é. –í—Å–µ baseline —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø—Ä–æ–≤–æ–¥–∏—Ç—å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –º–æ–¥–µ–ª–µ–π —Å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —Å–ª–æ–º–∞—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å.
