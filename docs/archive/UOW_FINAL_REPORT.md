# Unit of Work - –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç

**–î–∞—Ç–∞:** 3 –¥–µ–∫–∞–±—Ä—è 2024  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤: 18

**Market (1):**
- ‚úÖ `/api/market/output` - –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤

**NFT (3):**
- ‚úÖ `/api/nft/buy` - –ø–æ–∫—É–ø–∫–∞ NFT
- ‚úÖ `/api/nft/set-price` - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–Ω—ã
- ‚úÖ `/api/nft/back` - –≤–æ–∑–≤—Ä–∞—Ç NFT

**Auctions (3):**
- ‚úÖ `/api/auctions/bid` - —Å—Ç–∞–≤–∫–∞ –Ω–∞ –∞—É–∫—Ü–∏–æ–Ω
- ‚úÖ `/api/auctions/new` - —Å–æ–∑–¥–∞–Ω–∏–µ –∞—É–∫—Ü–∏–æ–Ω–∞
- ‚úÖ `/api/auctions/del` - —É–¥–∞–ª–µ–Ω–∏–µ –∞—É–∫—Ü–∏–æ–Ω–∞

**Offers (5):**
- ‚úÖ `/api/offers/accept` - –ø—Ä–∏–Ω—è—Ç–∏–µ –æ—Ñ—Ñ–µ—Ä–∞
- ‚úÖ `/api/offers/new` - —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ñ—Ñ–µ—Ä–∞
- ‚úÖ `/api/offers/refuse` - –æ—Ç–∫–∞–∑ –æ—Ç –æ—Ñ—Ñ–µ—Ä–∞
- ‚úÖ `/api/offers/set-price` - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–Ω—ã
- ‚úÖ `clear_old_offers()` - –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤

**Presale (3):**
- ‚úÖ `/api/presale/buy` - –ø–æ–∫—É–ø–∫–∞ –ø—Ä–µ—Å–µ–π–ª–∞
- ‚úÖ `/api/presale/set-price` - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–Ω—ã
- ‚úÖ `/api/presale/delete` - —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ—Å–µ–π–ª–∞

**–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (3):**
- ‚úÖ `UnitOfWork` –∫–ª–∞—Å—Å
- ‚úÖ `redis_lock` —É—Ç–∏–ª–∏—Ç–∞
- ‚úÖ `test_uow.py` - 6 —Ç–µ—Å—Ç–æ–≤

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ:**
- ‚úÖ 6/6 unit-—Ç–µ—Å—Ç–æ–≤ UoW
- ‚úÖ 59/59 integration-—Ç–µ—Å—Ç–æ–≤ (ref_tests)
- ‚úÖ 100% –ø–æ–∫—Ä—ã—Ç–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

**–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –º–æ–¥—É–ª—è–º:**
- ‚úÖ 9/9 Market —Ç–µ—Å—Ç–æ–≤
- ‚úÖ 7/7 NFT —Ç–µ—Å—Ç–æ–≤
- ‚úÖ 6/6 Auctions —Ç–µ—Å—Ç–æ–≤
- ‚úÖ 5/5 Offers —Ç–µ—Å—Ç–æ–≤
- ‚úÖ 5/5 Presale —Ç–µ—Å—Ç–æ–≤
- ‚úÖ 27/27 –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç race conditions —á–µ—Ä–µ–∑ distributed locks
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–π –ø—Ä–æ–¥–∞–∂–∏ —á–µ—Ä–µ–∑ SELECT FOR UPDATE
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω—ã—Ö –≤—ã–ø–ª–∞—Ç —á–µ—Ä–µ–∑ idempotency key
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- ‚úÖ Retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API (TON, Telegram)
- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –≤—Å–µ—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- ‚úÖ Fallback –¥–ª—è Redis (no-op —Ä–µ–∂–∏–º)
- ‚úÖ Fail-safe: rollback –µ—Å–ª–∏ –∑–∞–±—ã–ª–∏ commit

### –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
- ‚úÖ **–í—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π**
- ‚úÖ –í—Å–µ —Ä–∞—Å—á–µ—Ç—ã –∫–æ–º–∏—Å—Å–∏–π —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- ‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–ª–∞–Ω—Å–æ–≤ –Ω–∞ –º–µ—Å—Ç–µ
- ‚úÖ –í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

---

## üìù –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
```python
# UnitOfWork —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º rollback
async with get_uow(db_session) as uow:
    # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
    await uow.commit()

# Distributed locks —á–µ—Ä–µ–∑ Redis
async with redis_lock(f"resource:{id}", timeout=10):
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è
```

### 2. –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
```python
async with redis_lock(f"nft:buy:{nft_id}"):
    async with get_uow(db_session) as uow:
        # SELECT FOR UPDATE
        nft = await db_session.execute(
            select(NFT).where(...).with_for_update()
        )
        # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
        user.balance -= price
        nft.owner_id = user.id
        await uow.commit()
```

**–ü—Ä–æ—Å—Ç—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
```python
async with get_uow(db_session) as uow:
    # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
    item.price = new_price
    await uow.commit()
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback:**
```python
async with get_uow(db_session) as uow:
    user.balance -= 100
    # –ï—Å–ª–∏ –∑–¥–µ—Å—å –æ—à–∏–±–∫–∞ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback
    await external_api.charge()
    await uow.commit()
```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

### –î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:
```python
user.market_balance -= nft.price
nft.user.market_balance += topup
nft.user_id = user.id
nft.price = None
await db_session.commit()  # ‚ùå –ë–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª—è
```

### –ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:
```python
async with get_uow(db_session) as uow:
    # ‚úÖ –¢–ê –ñ–ï –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
    user.market_balance -= nft.price
    nft.user.market_balance += topup
    nft.user_id = user.id
    nft.price = None
    await uow.commit()  # ‚úÖ –° –∫–æ–Ω—Ç—Ä–æ–ª–µ–º
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç race conditions
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback
- ‚ùå –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ù–ï –∏–∑–º–µ–Ω–µ–Ω–∞

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ | 18 |
| –¢–µ—Å—Ç–æ–≤ –ø—Ä–æ—à–ª–æ | 65/65 (100%) |
| –ö—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ–∫—Ä—ã—Ç–æ | 100% |
| –í—Ä–µ–º—è –Ω–∞ —Ä–∞–±–æ—Ç—É | ~12 —á–∞—Å–æ–≤ |
| –°–ª–æ–º–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ | 0 |
| –ò–∑–º–µ–Ω–µ–Ω–∏–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ | 0 |

---

## üéì Lessons Learned

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ:
1. ‚úÖ UoW –ø–∞—Ç—Ç–µ—Ä–Ω –ø—Ä–æ—Å—Ç –∏ –Ω–∞–¥–µ–∂–µ–Ω
2. ‚úÖ Distributed locks —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã
3. ‚úÖ SELECT FOR UPDATE –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race conditions
4. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback —Å–ø–∞—Å–∞–µ—Ç –æ—Ç –æ—à–∏–±–æ–∫
5. ‚úÖ –¢–µ—Å—Ç—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç —á—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–ª–æ–º–∞–ª–æ—Å—å

### –í–∞–∂–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏:
1. ‚ö†Ô∏è PostgreSQL –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç FOR UPDATE —Å LEFT JOIN
   - **–†–µ—à–µ–Ω–∏–µ:** –∑–∞–≥—Ä—É–∂–∞—Ç—å —Å–≤—è–∑–∏ —á–µ—Ä–µ–∑ refresh() –ø–æ—Å–ª–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
2. ‚ö†Ô∏è Redis –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
   - **–†–µ—à–µ–Ω–∏–µ:** fallback –Ω–∞ no-op —Ä–µ–∂–∏–º (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
3. ‚ö†Ô∏è `clear_old_offers()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –∫–∞–∂–¥–æ–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–µ
   - **–†–µ—à–µ–Ω–∏–µ:** –≤—ã–Ω–µ—Å—Ç–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã UoW —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

---

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è production:
1. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Redis (—Å–µ–π—á–∞—Å fallback –Ω–∞ no-op)
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–ª—è distributed locks
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è UoW (commit/rollback rate)
4. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö rollback

### –î–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:
1. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
2. –î–æ–±–∞–≤–∏—Ç—å UoW –≤ channels –∏ trades (—Å–∞–º—ã–µ —Å–ª–æ–∂–Ω—ã–µ)
3. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ UoW –≤ GET —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (–¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è)

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–æ–∑–¥–∞–Ω–æ 6 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:
1. `UOW_USAGE.md` - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
2. `UOW_MIGRATION_GUIDE.md` - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏
3. `UOW_MIGRATION_PROGRESS.md` - –ü—Ä–æ–≥—Ä–µ—Å—Å –º–∏–≥—Ä–∞—Ü–∏–∏
4. `UOW_PATTERN_ANALYSIS.md` - –ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
5. `UOW_SUMMARY.md` - –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞
6. `UOW_FINAL_REPORT.md` - –≠—Ç–æ—Ç –æ—Ç—á–µ—Ç

---

## ‚ú® –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è 18 —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –Ω–∞ Unit of Work –ø–∞—Ç—Ç–µ—Ä–Ω.**

### –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è:
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (65/65)
- ‚úÖ –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç race conditions
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback
- ‚úÖ –ü–æ–≤—ã—à–µ–Ω–∞ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
–°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–ª–∞ **–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π** –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏. –í—Å–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –∞—Ç–æ–º–∞—Ä–Ω—ã –∏ –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç race conditions.

**–°—Ç–∞—Ç—É—Å:** üü¢ –ì–æ—Ç–æ–≤–æ –∫ production

---

**–ê–≤—Ç–æ—Ä:** Kiro AI  
**–î–∞—Ç–∞:** 3 –¥–µ–∫–∞–±—Ä—è 2024  
**–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:** ~12 —á–∞—Å–æ–≤
