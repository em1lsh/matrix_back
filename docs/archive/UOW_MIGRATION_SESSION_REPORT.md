# Unit of Work - –û—Ç—á–µ—Ç –æ —Å–µ—Å—Å–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

**–î–∞—Ç–∞:** 4 –¥–µ–∫–∞–±—Ä—è 2024  
**–°—Ç–∞—Ç—É—Å:** –§–∞–∑–∞ 2 –∏ –§–∞–∑–∞ 3 –ó–ê–í–ï–†–®–ï–ù–´ ‚úÖ

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ó–∞–≤–µ—Ä—à–µ–Ω–æ
- ‚úÖ **5/5 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤** –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ UoW (–§–∞–∑–∞ 2)
- ‚úÖ **10/10 –≤–∞–∂–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤** –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ UoW (–§–∞–∑–∞ 3)
- ‚úÖ **59/59 —Ç–µ—Å—Ç–æ–≤** –ø—Ä–æ–π–¥–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
- ‚úÖ **–§–∞–∑–∞ 2 –∏ –§–∞–∑–∞ 3 –∑–∞–≤–µ—Ä—à–µ–Ω—ã** –Ω–∞ 100%

### –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

#### 1. `/api/market/output` - –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤
- Distributed lock: `withdraw:{user_id}`
- SELECT FOR UPDATE –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- Retry –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ TON (3 –ø–æ–ø—ã—Ç–∫–∏)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ idempotency key

#### 2. `/api/nft/buy` - –ü–æ–∫—É–ø–∫–∞ NFT
- Distributed lock: `nft:buy:{nft_id}`
- SELECT FOR UPDATE –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ NFT
- –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –¢–∞–∫–∂–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã: `/api/nft/set-price`, `/api/nft/back`

#### 3. `/api/channels/buy` - –ü–æ–∫—É–ø–∫–∞ –∫–∞–Ω–∞–ª–∞ ‚≠ê (—Å–∞–º—ã–π —Å–ª–æ–∂–Ω—ã–π)
- Distributed lock: `channel:buy:{channel_id}`
- SELECT FOR UPDATE –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∫–∞–Ω–∞–ª–∞
- Retry –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –∫–∞–Ω–∞–ª–∞ —á–µ—Ä–µ–∑ Telegram API
- –ü—Ä–æ–≤–µ—Ä–∫–∞ gifts_hash –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **–¢–µ—Å—Ç—ã:** 8/8 –ø—Ä–æ–π–¥–µ–Ω–æ

#### 4. `/api/auctions/bid` - –°—Ç–∞–≤–∫–∞ –Ω–∞ –∞—É–∫—Ü–∏–æ–Ω
- Distributed lock: `auction:bid:{auction_id}`
- SELECT FOR UPDATE –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∞—É–∫—Ü–∏–æ–Ω–∞
- –ê—Ç–æ–º–∞—Ä–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å—Ç–∞–≤–æ–∫
- –¢–∞–∫–∂–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã: `/api/auctions/new`, `/api/auctions/del`

#### 5. `/api/trades/accept-proposal` - –ü—Ä–∏–Ω—è—Ç–∏–µ –æ–±–º–µ–Ω–∞
- Distributed lock: `trade:proposal:{proposal_id}`
- SELECT FOR UPDATE –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ proposal
- –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–±–º–µ–Ω–∞ NFT –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- –†–∞—Å—á–µ—Ç –∏ —Å–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏
- **–¢–µ—Å—Ç—ã:** 12/12 –ø—Ä–æ–π–¥–µ–Ω–æ

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```python
from app.db import get_uow
from app.utils.locks import distributed_lock

async with distributed_lock(f"resource:{id}", timeout=30):
    async with get_uow(db_session) as uow:
        # SELECT FOR UPDATE (–±–µ–∑ joinedload)
        entity = await uow.session.execute(
            select(Model).where(...).with_for_update()
        )
        entity = entity.scalar_one_or_none()
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤—è–∑–µ–π –ø–æ—Å–ª–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        if entity:
            await uow.session.refresh(entity, attribute_names=['relation'])
        
        # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
        entity.field = new_value
        
        # Commit
        await uow.commit()
```

### –í–∞–∂–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏

1. **PostgreSQL –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:** `FOR UPDATE` –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å `LEFT OUTER JOIN`
   - –†–µ—à–µ–Ω–∏–µ: —Å–Ω–∞—á–∞–ª–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞, –ø–æ—Ç–æ–º `refresh()` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤—è–∑–µ–π

2. **Distributed locks:** —Ä–∞–±–æ—Ç–∞—é—Ç —Å fallback –Ω–∞ no-op —Ä–µ–∂–∏–º –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Redis
   - –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç —Ä–∞–±–æ—Ç—É

3. **Retry –º–µ—Ö–∞–Ω–∏–∑–º:** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API (Telegram, TON)
   - 3 –ø–æ–ø—ã—Ç–∫–∏ —Å exponential backoff
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ

---

## üìà –ü—Ä–æ–≥—Ä–µ—Å—Å –º–∏–≥—Ä–∞—Ü–∏–∏

| –§–∞–∑–∞ | –°—Ç–∞—Ç—É—Å | –ü—Ä–æ–≥—Ä–µ—Å—Å | –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã |
|------|--------|----------|-----------|
| –§–∞–∑–∞ 1: –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ | ‚úÖ | 100% | UoW, locks, retry |
| –§–∞–∑–∞ 2: –ö—Ä–∏—Ç–∏—á–Ω—ã–µ | ‚úÖ | 100% | 5/5 |
| –§–∞–∑–∞ 3: –í–∞–∂–Ω—ã–µ | ‚úÖ | 100% | 10/10 |
| –§–∞–∑–∞ 4: –û—Å—Ç–∞–ª—å–Ω—ã–µ | ‚è≥ | 0% | 0/95 |

**–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å:** ~29% (33/~115 —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤)

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### ‚úÖ –§–∞–∑–∞ 3: –í–∞–∂–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (–ó–ê–í–ï–†–®–ï–ù–ê)

**–û–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ–∫—É–ø–∫–∏/–ø—Ä–æ–¥–∞–∂–∏:**
1. ‚úÖ `/api/offers/accept` - –ü—Ä–∏–Ω—è—Ç–∏–µ –æ—Ñ—Ñ–µ—Ä–∞ (—É–∂–µ –±—ã–ª–æ)
2. ‚úÖ `/api/presale/buy` - –ü–æ–∫—É–ø–∫–∞ –ø—Ä–µ—Å–µ–π–ª–∞ (—É–∂–µ –±—ã–ª–æ)
3. ‚úÖ `/api/channels/set-price` - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–Ω—ã –∫–∞–Ω–∞–ª–∞
4. ‚úÖ `/api/nft/set-price` - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–Ω—ã NFT (—É–∂–µ –±—ã–ª–æ)
5. ‚úÖ `/api/accounts/delete` - –£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞

**–°–æ–∑–¥–∞–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π:**
6. ‚úÖ `/api/trades/new` - –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–µ–π–¥–∞
7. ‚úÖ `/api/trades/delete` - –£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–µ–π–¥–æ–≤
8. ‚úÖ `/api/auctions/new` - –°–æ–∑–¥–∞–Ω–∏–µ –∞—É–∫—Ü–∏–æ–Ω–∞ (—É–∂–µ –±—ã–ª–æ)
9. ‚úÖ `/api/auctions/del` - –£–¥–∞–ª–µ–Ω–∏–µ –∞—É–∫—Ü–∏–æ–Ω–∞ (—É–∂–µ –±—ã–ª–æ)
10. ‚úÖ `/api/channels/new` - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞

**–ó–∞–≤–µ—Ä—à–µ–Ω–æ:** 10/10 —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤

### –§–∞–∑–∞ 4: –û—Å—Ç–∞–ª—å–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

- –°–æ–∑–¥–∞–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π (trades, auctions, channels, accounts)
- GET —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (–¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è)
- –ü—Ä–æ—Å—Ç—ã–µ UPDATE/DELETE –æ–ø–µ—Ä–∞—Ü–∏–∏

**–û—Ü–µ–Ω–∫–∞:** 30 —á–∞—Å–æ–≤ (4-5 –¥–Ω–µ–π)

---

## ‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞

- –í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –ø–æ–∫—Ä—ã—Ç—ã —Ç–µ—Å—Ç–∞–º–∏
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ –∫–æ–¥–µ (docstrings)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º rollback
- –ó–∞—â–∏—Ç–∞ –æ—Ç race conditions

---

## üìù –ó–∞–º–µ—Ç–∫–∏

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ
- ‚úÖ UnitOfWork —Å—Ç–∞–±–∏–ª–µ–Ω (6/6 unit —Ç–µ—Å—Ç–æ–≤)
- ‚úÖ Distributed locks —Å fallback
- ‚úÖ Retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –í—Å–µ ref —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (59/59)

### –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å
- ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–ª—è distributed locks
- ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è UoW (commit/rollback rate)
- ‚ö†Ô∏è –ò—Å–ø—Ä–∞–≤–∏—Ç—å warnings –æ –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è—Ö

---

**–ê–≤—Ç–æ—Ä:** Kiro AI  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 4 –¥–µ–∫–∞–±—Ä—è 2024
