# –ü—Ä–æ–≥—Ä–µ—Å—Å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–∞ Use Cases

## ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

### NFT Use Cases (3/3)

#### 1. BuyNFTUseCase ‚úÖ
**–§–∞–π–ª:** `backend/project/app/use_cases/nft/buy_nft.py`

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- ‚úÖ –°–æ–∑–¥–∞–Ω use case —Å –ø–æ–ª–Ω–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π
- ‚úÖ –í—ã–Ω–µ—Å–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∏–∑ —Ä–æ—É—Ç–µ—Ä–∞ `/nft/buy`
- ‚úÖ –†–æ—É—Ç–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è use case
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (redis_lock, SELECT FOR UPDATE)
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ù–∞–ø–∏—Å–∞–Ω—ã unit —Ç–µ—Å—Ç—ã

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**
- Distributed lock –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥–≤–æ–π–Ω–æ–π –ø—Ä–æ–¥–∞–∂–∏
- SELECT FOR UPDATE –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ NFT
- –í–∞–ª–∏–¥–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
- –†–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏ –º–∞—Ä–∫–µ—Ç–∞
- –°–æ–∑–¥–∞–Ω–∏–µ NFTDeal
- –ê—Ç–æ–º–∞—Ä–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–≤—Ü–∞

**–¢–µ—Å—Ç—ã:**
- `test_buy_nft_success` - —É—Å–ø–µ—à–Ω–∞—è –ø–æ–∫—É–ø–∫–∞
- `test_buy_nft_not_found` - NFT –Ω–µ –Ω–∞–π–¥–µ–Ω
- `test_buy_nft_insufficient_balance` - –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤
- `test_buy_nft_commission_calculation` - —Ä–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏

---

#### 2. SetNFTPriceUseCase ‚úÖ
**–§–∞–π–ª:** `backend/project/app/use_cases/nft/set_price.py`

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- ‚úÖ –°–æ–∑–¥–∞–Ω use case
- ‚úÖ –†–æ—É—Ç–µ—Ä `/nft/set-price` –æ–±–Ω–æ–≤–ª–µ–Ω
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è NFT
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞/—Å–±—Ä–æ—Å —Ü–µ–Ω—ã
- –í–∞–ª–∏–¥–∞—Ü–∏—è —á—Ç–æ NFT –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∞–∫–∫–∞—É–Ω—Ç—É

---

#### 3. ReturnNFTUseCase ‚úÖ
**–§–∞–π–ª:** `backend/project/app/use_cases/nft/return_nft.py`

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- ‚úÖ –°–æ–∑–¥–∞–Ω use case
- ‚úÖ –†–æ—É—Ç–µ—Ä `/nft/back` –æ–±–Ω–æ–≤–ª–µ–Ω
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã redis_lock –∏ retry

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**
- Distributed lock –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race conditions
- –í–∞–ª–∏–¥–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –∫–æ–º–∏—Å—Å–∏–∏ (0.1 TON)
- –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram API —Å retry
- –°–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏
- –£–¥–∞–ª–µ–Ω–∏–µ NFT –∏–∑ –ë–î

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ö–æ–¥
- **Use Cases —Å–æ–∑–¥–∞–Ω–æ:** 3
- **–†–æ—É—Ç–µ—Ä–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–æ:** 3
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞ –≤ use cases:** ~350
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞ —É–¥–∞–ª–µ–Ω–æ –∏–∑ —Ä–æ—É—Ç–µ—Ä–æ–≤:** ~120

### –¢–µ—Å—Ç—ã
- **Unit —Ç–µ—Å—Ç–æ–≤ –Ω–∞–ø–∏—Å–∞–Ω–æ:** 4
- **–ü–æ–∫—Ä—ã—Ç–∏–µ:** BuyNFTUseCase (–æ—Å–Ω–æ–≤–Ω–æ–π use case)

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –§–∞–∑–∞ 2: Channels Use Cases (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –í–´–°–û–ö–ò–ô)

#### 1. BuyChannelUseCase
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è (Telegram API, –≤–∞–ª–∏–¥–∞—Ü–∏—è gifts_hash)

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞ –∏ —Ü–µ–Ω—ã
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram –∫–ª–∏–µ–Ω—Ç–∞
- –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö gifts
- **–í–∞–ª–∏–¥–∞—Ü–∏—è gifts_hash** (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
- –ü–µ—Ä–µ–¥–∞—á–∞ –ø—Ä–∞–≤ –≤–ª–∞–¥–µ–Ω–∏—è —á–µ—Ä–µ–∑ Telegram API
- –û–±—Ä–∞–±–æ—Ç–∫–∞ UserNotMutualContactError
- –†–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏
- –°–æ–∑–¥–∞–Ω–∏–µ ChannelDeal
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–û—Ü–µ–Ω–∫–∞:** 2-3 —á–∞—Å–∞

---

#### 2. AddChannelUseCase
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è (Telegram API, —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ gifts)

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram –∫–ª–∏–µ–Ω—Ç–∞
- –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ —á–µ—Ä–µ–∑ API
- –í–∞–ª–∏–¥–∞—Ü–∏—è —á—Ç–æ —ç—Ç–æ –∫–∞–Ω–∞–ª
- –í–∞–ª–∏–¥–∞—Ü–∏—è —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - —Å–æ–∑–¥–∞—Ç–µ–ª—å
- –ü–æ–ª—É—á–µ–Ω–∏–µ gifts –∫–∞–Ω–∞–ª–∞
- –†–∞—Å—á–µ—Ç gifts_hash
- –°–æ–∑–¥–∞–Ω–∏–µ Channel
- –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Gift –∏ ChannelGift

**–û—Ü–µ–Ω–∫–∞:** 3-4 —á–∞—Å–∞

---

### –§–∞–∑–∞ 3: Auctions Use Cases

#### 1. PlaceBidUseCase
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è (–≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º)

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∞—É–∫—Ü–∏–æ–Ω–∞
- –í–∞–ª–∏–¥–∞—Ü–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å—Ç–∞–≤–∫–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è —à–∞–≥–∞ —Å—Ç–∞–≤–∫–∏
- **–í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –ø—Ä–µ–¥—ã–¥—É—â–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º**
- –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç–∞–≤–∫–∏
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ last_bid

**–û—Ü–µ–Ω–∫–∞:** 2 —á–∞—Å–∞

---

### –§–∞–∑–∞ 4: Offers Use Cases

#### 1. AcceptOfferUseCase
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è (–ø–æ—Ö–æ–∂–µ –Ω–∞ BuyNFT)

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**
- –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –æ—Ñ—Ñ–µ—Ä–∞
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã (price –∏–ª–∏ reciprocal_price)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
- –†–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏
- –°–æ–∑–¥–∞–Ω–∏–µ NFTDeal
- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ñ—Ñ–µ—Ä–∞
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

**–û—Ü–µ–Ω–∫–∞:** 1-2 —á–∞—Å–∞

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –¥–ª—è merge

### –ü–µ—Ä–µ–¥ merge –≤ –æ—Å–Ω–æ–≤–Ω—É—é –≤–µ—Ç–∫—É:

1. **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** ‚úÖ
   - [x] –í—Å–µ use cases —Å–æ–∑–¥–∞–Ω—ã
   - [x] –†–æ—É—Ç–µ—Ä—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
   - [ ] Ref tests –ø—Ä–æ—Ö–æ–¥—è—Ç (–Ω—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å)

2. **–¢–µ—Å—Ç—ã**
   - [x] Unit —Ç–µ—Å—Ç—ã –¥–ª—è BuyNFTUseCase
   - [ ] Unit —Ç–µ—Å—Ç—ã –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö use cases
   - [ ] Ref tests –ø—Ä–æ—Ö–æ–¥—è—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
   - [ ] Load tests –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —É–ª—É—á—à–µ–Ω–∏–µ –∏–ª–∏ –±–µ–∑ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏
   - [ ] –ù–µ—Ç –Ω–æ–≤—ã—Ö N+1 queries

4. **–ö–æ–¥**
   - [x] –õ–∏–Ω—Ç–µ—Ä –ø—Ä–æ—Ö–æ–¥–∏—Ç
   - [x] Type hints –≤–µ–∑–¥–µ
   - [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
   - [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ docstrings

---

## üöÄ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ó–∞–ø—É—Å–∫ ref tests –¥–ª—è NFT
```bash
cd backend
pytest tests/ref_tests/test_ref_nft.py -v
```

### –ó–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç–æ–≤ use cases
```bash
cd backend
pytest tests/use_cases/ -v
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–µ—Ä–∞
```bash
cd backend
ruff check project/app/use_cases/
```

### –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
```bash
cd backend
pytest tests/ -v
```

---

## üìù –ó–∞–º–µ—Ç–∫–∏

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ:
- Use cases –ø–æ–ª—É—á–∏–ª–∏—Å—å —á–∏—Å—Ç—ã–º–∏ –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã–º–∏
- –†–æ—É—Ç–µ—Ä—ã —Å—Ç–∞–ª–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—â–µ (—Ç–æ–ª—å–∫–æ HTTP –ª–æ–≥–∏–∫–∞)
- –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (locks, SELECT FOR UPDATE)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–ª–æ—Å—å –Ω–∞ –º–µ—Å—Ç–µ

### –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å:
- –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ unit —Ç–µ—Å—Ç–æ–≤ –¥–ª—è edge cases
- –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å BaseUseCase –¥–ª—è –æ–±—â–µ–π –ª–æ–≥–∏–∫–∏
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ use cases

### –†–∏—Å–∫–∏:
- –ù—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ ref tests –ø—Ä–æ—Ö–æ–¥—è—Ç
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π
