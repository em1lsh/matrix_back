# –ß–µ–∫–ª–∏—Å—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è

## –î–∞—Ç–∞: 2024-12-02
## –°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

---

## ‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–í—ã–ø–æ–ª–Ω–µ–Ω–æ)

- [x] –°–æ–∑–¥–∞–Ω–∞ —É—Ç–∏–ª–∏—Ç–∞ `app/utils/security.py`
- [x] –î–æ–±–∞–≤–ª–µ–Ω `encryption_key` –≤ –∫–æ–Ω—Ñ–∏–≥
- [x] –û–±–Ω–æ–≤–ª–µ–Ω `pyproject.toml` —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
- [x] –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `add_encryption_columns.py`
- [x] –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `migrate_sensitive_data.py`
- [x] –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `generate_encryption_key.py`
- [x] –û–±–Ω–æ–≤–ª–µ–Ω—ã –º–æ–¥–µ–ª–∏ Account –∏ TonnelAccount
- [x] –û–±–Ω–æ–≤–ª–µ–Ω –∫–æ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ `account.py`
- [x] –°–æ–∑–¥–∞–Ω—ã —Ç–µ—Å—Ç—ã `test_security.py`
- [x] –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `drop_old_password_columns.py` (–Ω–µ –ø—Ä–∏–º–µ–Ω—è—Ç—å —Å—Ä–∞–∑—É!)
- [x] –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

## ‚è≥ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ (TODO)

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd backend
poetry install
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
poetry show | grep -E "passlib|bcrypt|cryptography"
```

–î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å:
- passlib
- bcrypt  
- cryptography

---

### –®–∞–≥ 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è

```bash
cd project
python generate_encryption_key.py
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á

---

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤–∏—Ç—å –≤ `.env`:
```env
ENCRYPTION_KEY=<generated_key_from_step_2>
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
grep ENCRYPTION_KEY .env
```

**‚ö†Ô∏è –í–ê–ñ–ù–û:** 
- –ù–µ –∫–æ–º–º–∏—Ç–∏—Ç—å –∫–ª—é—á –≤ git!
- –°–¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø –∫–ª—é—á–∞ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –º–µ—Å—Ç–æ
- –î–ª—è production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å secrets manager

---

### –®–∞–≥ 4: –ë—ç–∫–∞–ø –ë–î

```bash
# PostgreSQL
docker compose exec db pg_dump -U loadtest_user loadtest_db | gzip > backup_$(date +%Y%m%d_%H%M%S).sql.gz
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
ls -lh backup_*.sql.gz
```

–î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω —Ñ–∞–π–ª –±—ç–∫–∞–ø–∞.

---

### –®–∞–≥ 5: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

```bash
cd project
poetry run alembic upgrade head
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```sql
-- –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î
docker compose exec db psql -U loadtest_user loadtest_db

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏
\d accounts
\d tonnel_accounts
```

–î–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ–ª–æ–Ω–∫–∏:
- `accounts.password_hash`
- `tonnel_accounts.auth_data_encrypted`

---

### –®–∞–≥ 6: –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

```bash
cd project
python migrate_sensitive_data.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
MIGRATING PASSWORDS
Found X accounts with passwords
‚úì Migrated X passwords

MIGRATING AUTH DATA
Found Y Tonnel accounts with auth_data
‚úì Migrated Y auth_data records

VERIFYING MIGRATION
‚úÖ All data migrated successfully!
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–∞—Ä–æ–ª–∏ –∑–∞—Ö–µ—à–∏—Ä–æ–≤–∞–Ω—ã
SELECT id, password, password_hash FROM accounts WHERE password IS NOT NULL LIMIT 5;

-- password_hash –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å $2b$

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ auth_data –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã
SELECT id, auth_data, auth_data_encrypted FROM tonnel_accounts WHERE auth_data IS NOT NULL LIMIT 5;

-- auth_data_encrypted –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω
```

---

### –®–∞–≥ 7: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
cd project
poetry run pytest ../tests/test_security.py -v
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ —Ç–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏

---

### –®–∞–≥ 8: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

1. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**
```bash
docker compose up -d
docker compose logs -f app
```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–µ—Ç –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ**

3. **–¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
   - [ ] –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ —Å –ø–∞—Ä–æ–ª–µ–º
   - [ ] –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–∞—Ä–æ–ª–µ–º
   - [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è
   - [ ] –†–∞–±–æ—Ç–∞ —Å Tonnel API (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

---

### –®–∞–≥ 9: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–ø–µ—Ä–≤—ã–µ 24 —á–∞—Å–∞)

–°–ª–µ–¥–∏—Ç—å –∑–∞:
- [ ] –õ–æ–≥–∞–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–æ—à–∏–±–∫–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏)
- [ ] –í—Ä–µ–º–µ–Ω–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (bcrypt –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ)
- [ ] –û—à–∏–±–∫–∞–º–∏ –≤ Sentry/–ª–æ–≥–∞—Ö

**–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**
```bash
# –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
docker compose logs -f app | grep -i "error\|password\|auth"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
docker compose exec app python -c "
from app.utils.security import hash_password
import time
start = time.time()
hash_password('test')
print(f'Hash time: {time.time() - start:.3f}s')
"
```

---

### –®–∞–≥ 10: –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ (—á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é)

**‚ö†Ô∏è –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!**

```bash
cd project
poetry run alembic upgrade head
```

–≠—Ç–æ –ø—Ä–∏–º–µ–Ω–∏—Ç –º–∏–≥—Ä–∞—Ü–∏—é `drop_old_password_columns.py`.

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```sql
\d accounts
\d tonnel_accounts
```

–ö–æ–ª–æ–Ω–∫–∏ `password` –∏ `auth_data` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–¥–∞–ª–µ–Ω—ã.

---

## üîÑ –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)

### –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö

1. **–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**
```bash
docker compose down
```

2. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î –∏–∑ –±—ç–∫–∞–ø–∞:**
```bash
gunzip < backup_YYYYMMDD_HHMMSS.sql.gz | docker compose exec -T db psql -U loadtest_user loadtest_db
```

3. **–û—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î:**
```bash
cd project
poetry run alembic downgrade -1
```

4. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**
```bash
docker compose up -d
```

---

## ‚ùå –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: "ENCRYPTION_KEY not configured"

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫–ª—é—á –≤ .env
grep ENCRYPTION_KEY .env

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
docker compose restart app
```

### –ü—Ä–æ–±–ª–µ–º–∞: "Failed to decrypt data"

**–ü—Ä–∏—á–∏–Ω—ã:**
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
- –î–∞–Ω–Ω—ã–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã
- –î–∞–Ω–Ω—ã–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã –¥—Ä—É–≥–∏–º –∫–ª—é—á–æ–º

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á –≤ .env
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –º–∏–≥—Ä–∞—Ü–∏–∏
3. –û—Ç–∫–∞—Ç–∏—Ç—å –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–µ–¥–ª–µ–Ω–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

**–ü—Ä–∏—á–∏–Ω–∞:** bcrypt —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –º–µ–¥–ª–µ–Ω–Ω—ã–π –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç brute-force

**–†–µ—à–µ–Ω–∏–µ:**
- –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ (0.1-0.3 —Å–µ–∫—É–Ω–¥—ã)
- –ï—Å–ª–∏ –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ (>1 —Å–µ–∫), –ø—Ä–æ–≤–µ—Ä–∏—Ç—å CPU

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

- [ ] –í—Å–µ –ø–∞—Ä–æ–ª–∏ –∑–∞—Ö–µ—à–∏—Ä–æ–≤–∞–Ω—ã (password_hash –∑–∞–ø–æ–ª–Ω–µ–Ω)
- [ ] –í—Å–µ auth_data –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã (auth_data_encrypted –∑–∞–ø–æ–ª–Ω–µ–Ω)
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö
- [ ] –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –í—Ä–µ–º—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–µ–º–ª–µ–º–æ–µ (<1 —Å–µ–∫)
- [ ] –°—Ç–∞—Ä—ã–µ –∫–æ–ª–æ–Ω–∫–∏ —É–¥–∞–ª–µ–Ω—ã (—á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é)

---

## üìù –§–∏–Ω–∞–ª—å–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç

### –ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º –Ω–∞ production:

- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã –Ω–∞ dev
- [ ] –ë—ç–∫–∞–ø –ë–î —Å–æ–∑–¥–∞–Ω
- [ ] –ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –≤ secrets manager
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] –ö–æ–º–∞–Ω–¥–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∞ –æ –¥–µ–ø–ª–æ–µ
- [ ] –ü–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞ –≥–æ—Ç–æ–≤

### –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:

- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–µ—Ä–≤—ã–µ 24 —á–∞—Å–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫
- [ ] –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ (—á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é)
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

---

## üéâ –ì–æ—Ç–æ–≤–æ!

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤:
- ‚úÖ –ü–∞—Ä–æ–ª–∏ –∑–∞—â–∏—â–µ–Ω—ã bcrypt —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- ‚úÖ Auth_data –∑–∞—â–∏—â–µ–Ω—ã AES-256 —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º
- ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ production
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –∏–Ω–¥—É—Å—Ç—Ä–∏–∞–ª—å–Ω—ã—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤
