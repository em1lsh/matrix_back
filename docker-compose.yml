services:
  app:
    build:
      context: .
      dockerfile: docker/Dockerfile
      args:
        APP_UID: ${APP_UID:-1000}
        APP_GID: ${APP_GID:-1000}
    restart: always
    environment:
      DATABASE: ${DATABASE:?DATABASE is required}
      DOMAIN: ${DOMAIN:?DOMAIN is required}
      BOT_TOKEN: ${BOT_TOKEN:?BOT_TOKEN is required}
      PARSER_ACCOUNT: ${PARSER_ACCOUNT:?PARSER_ACCOUNT is required}
      BANK_ACCOUNT: ${BANK_ACCOUNT:?BANK_ACCOUNT is required}
      CHANNEL_USERNAME: ${CHANNEL_USERNAME:?CHANNEL_USERNAME is required}
      MARKET_CHAT: ${MARKET_CHAT:?MARKET_CHAT is required}
      SUPPORT_URL: ${SUPPORT_URL:?SUPPORT_URL is required}
      ADMINS: ${ADMINS:?ADMINS is required}
      PARSER_PREFIX: ${PARSER_PREFIX:?PARSER_PREFIX is required}
      TON_COMISSION: ${TON_COMISSION:-0.01}
      MARKET_COMISSION: ${MARKET_COMISSION:-1}
      TRADE_COMISSION: ${TRADE_COMISSION:-2}
      TONCENTER_API_KEY: ${TONCENTER_API_KEY:?TONCENTER_API_KEY is required}
      TONCONSOLE_API_KEY: ${TONCONSOLE_API_KEY:?TONCONSOLE_API_KEY is required}
      OUTPUT_WALLET: ${OUTPUT_WALLET:?OUTPUT_WALLET is required}
      OUTPUT_WALLET_MNEMONIC: ${OUTPUT_WALLET_MNEMONIC:?OUTPUT_WALLET_MNEMONIC is required}
      LOGS_CHAT_ID: ${LOGS_CHAT_ID:?LOGS_CHAT_ID is required}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      ENABLE_TELEGRAM_INIT: ${ENABLE_TELEGRAM_INIT:-true}
      LOG_RETENTION_DAYS: ${LOG_RETENTION_DAYS:-7}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-}
      SLACK_WEBHOOK_URL: ${SLACK_WEBHOOK_URL:?SLACK_WEBHOOK_URL is required}
      FRAGMENT_API_KEY: ${FRAGMENT_API_KEY:-}
      STARS_MARKUP_PERCENT: ${STARS_MARKUP_PERCENT:-10}
      GIFTASSET_API_KEY: ${GIFTASSET_API_KEY:-}
    volumes:
      - type: bind
        source: ./project/media
        target: /app/media
      - type: bind
        source: ./project/app/sessions
        target: /app/app/sessions
      - type: bind
        source: ./project/logs
        target: /app/logs
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    expose:
      - "8000"

  postgres:
    image: postgres:16
    restart: always
    environment:
      POSTGRES_DB: ${PG_DATABASE:?PG_DATABASE is required}
      POSTGRES_USER: ${PG_USER:?PG_USER is required}
      POSTGRES_PASSWORD: ${PG_PASSWORD:?PG_PASSWORD is required}
    ports:
      - "127.0.0.1:${PG_PORT:-5432}:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U \"$${POSTGRES_USER}\" -d \"$${POSTGRES_DB}\""]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--save", "60", "1", "--loglevel", "warning"]
    restart: always
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

  nginx:
    image: nginx:alpine
    restart: always
    depends_on:
      - app
    ports:
      - "127.0.0.1:${APP_PORT:-8000}:8000"
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro

volumes:
  redis_data:
  pg_data: